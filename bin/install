#!/bin/bash -eu

source $OPENSHIFT_DV_DIR/bin/util

case "$1" in
  -v|--version)
    version="$2"
esac

echo "$version" > "$OPENSHIFT_DV_DIR/env/OPENSHIFT_DV_VERSION"

ln -s ${OPENSHIFT_DV_DIR}/standalone/log ${OPENSHIFT_DV_DIR}/logs

shopt -s dotglob
cp -r ${OPENSHIFT_DV_DIR}/versions/${version}/template/* ${OPENSHIFT_DV_DIR}/template
mv ${OPENSHIFT_DV_DIR}/versions/${version}/share/* ${OPENSHIFT_DV_DIR}/share
mv ${OPENSHIFT_DV_DIR}/versions/${version}/jboss/modules ${OPENSHIFT_DV_DIR}/jboss
mv ${OPENSHIFT_DV_DIR}/versions/${version}/jboss/jboss-modules.jar ${OPENSHIFT_DV_DIR}/jboss
cp ${OPENSHIFT_DV_DIR}/standalone/configuration/standalone.xml ${OPENSHIFT_DV_DIR}/template/.openshift/config
cp ${OPENSHIFT_DV_DIR}/versions/${version}/standalone/deployments/CustomerRESTWebSvc.war ${OPENSHIFT_DV_DIR}/standalone/deployments/CustomerRESTWebSvc.war
cp ${OPENSHIFT_DV_DIR}/versions/${version}/standalone/deployments/datavirt-1.0.war ${OPENSHIFT_DV_DIR}/standalone/deployments/datavirt-1.0.war
cp ${OPENSHIFT_DV_DIR}/versions/${version}/standalone/deployments/datavirt-commons-idp-eap61-1.0.0.war ${OPENSHIFT_DV_DIR}/standalone/deployments/datavirt-commons-idp-eap61-1.0.0.war
cp ${OPENSHIFT_DV_DIR}/versions/${version}/standalone/deployments/datavirt-ui-eap61.war ${OPENSHIFT_DV_DIR}/standalone/deployments/datavirt-ui-eap61.war
cp ${OPENSHIFT_DV_DIR}/versions/${version}/standalone/deployments/teiid-dashboard-distribution-builder-1.0.0-redhat-1-jboss-as7.war ${OPENSHIFT_DV_DIR}/standalone/deployments/teiid-dashboard-distribution-builder-1.0.0-redhat-1-jboss-as7.war

pushd $OPENSHIFT_DV_DIR/template/src/main/webapp
  jar cvf $OPENSHIFT_DV_DIR/standalone/deployments/ROOT.war ./*
popd

JBOSS_HOME=${OPENSHIFT_DV_DIR}/jboss
pushd $OPENSHIFT_DV_DIR > /dev/null
  ln -s ${JBOSS_HOME}/jboss-modules.jar
  ln -s ${JBOSS_HOME}/modules
popd 1> /dev/null

touch ${OPENSHIFT_DV_DIR}/env/OPENSHIFT_DV_CLUSTER
touch ${OPENSHIFT_DV_DIR}/env/OPENSHIFT_DV_CLUSTER_REMOTING

update-configuration java7
